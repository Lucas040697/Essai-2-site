<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur de Protocoles Sensoriels avec Assistant IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals -->
    <!-- Application Structure Plan: An interactive dashboard-style single-page application. A persistent left-hand navigation sidebar allows users to select one of the 6 main sections of the protocol. The main content area dynamically displays the details of the selected section. This structure breaks down the dense report into manageable, task-oriented chunks, facilitating non-linear exploration and learning. Key information like test types and measurement scales are transformed from static tables into interactive components (tabs, charts) to make comparisons more intuitive and engaging. This design prioritizes user understanding and ease of reference over a simple linear representation of the source document. -->
    <!-- Visualization & Content Choices: 
        - General Structure: Content is organized into expandable accordion cards for each of the 20 points, preventing information overload. Goal: Organize. Method: HTML/CSS/JS.
        - Test Types: An interactive tab component replaces the static table. Goal: Compare & Inform. Method: HTML/JS to filter content. A Chart.js bar chart is added to visualize the typical panel size for each test type, making the difference more salient. Justification: Enhances understanding by allowing direct comparison and providing a visual anchor for quantitative differences.
        - Measurement Scales: An interactive tab component replaces the static table. Goal: Compare & Organize. Method: HTML/JS to switch between detailed views of each scale. Justification: Simplifies the comparison of different tools by presenting their characteristics in a consistent, easily switchable format.
        - Process Flow (e.g., balanced order): Simple diagrams built with styled HTML/Tailwind divs are used instead of text-only descriptions. Goal: Inform & Clarify. Method: HTML/CSS. Justification: Visual diagrams are more effective for explaining abstract procedural concepts.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f7f4; 
            color: #2d3748;
        }
        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            font-weight: 500;
            color: #4a5568;
        }
        .nav-link:hover {
            background-color: #e2e8f0;
        }
        .nav-link.active {
            background-color: #a78bfa; /* Soft Violet */
            color: #ffffff;
            font-weight: 600;
        }
        .nav-link .icon {
            margin-right: 0.75rem;
            width: 1.25rem;
            height: 1.25rem;
        }
        .accordion-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .accordion-header:hover {
            background-color: #fafafa;
        }
        .accordion-content {
            display: none;
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            background-color: #ffffff;
        }
        .accordion-content.open {
            display: block;
        }
        .accordion-arrow {
            transition: transform 0.3s;
        }
        .accordion-header.open .accordion-arrow {
            transform: rotate(180deg);
        }
        .tab-button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            background-color: #e2e8f0;
            color: #4a5568;
        }
        .tab-button.active {
            background-color: #a78bfa;
            color: #ffffff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 350px;
        }
        .form-input, .form-textarea {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #a78bfa;
            box-shadow: 0 0 0 2px rgba(167, 139, 250, 0.4);
        }
        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }
        .ai-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: #ede9fe;
            color: #6d28d9;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .ai-button:hover {
            background-color: #ddd6fe;
        }
        .ai-button:disabled {
            background-color: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
        }
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5rem;
            z-index: 9999;
        }
    </style>
</head>
<body class="antialiased">
    <div id="loading-overlay" class="hidden">Génération en cours...</div>
    <div class="flex h-screen bg-gray-100">
        <aside class="w-72 bg-white shadow-md flex-shrink-0 flex flex-col">
            <div class="p-4">
                <h1 class="text-xl font-bold text-violet-700">Générateur de Protocole</h1>
                <p class="text-sm text-gray-500">avec Assistant IA</p>
            </div>
            <nav id="main-nav" class="p-4 space-y-2 flex-1 overflow-y-auto">
            </nav>
            <div class="p-4 border-t border-gray-200">
                <button id="export-pdf-button" class="w-full flex items-center justify-center gap-2 bg-violet-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-violet-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    Exporter en PDF
                </button>
            </div>
        </aside>

        <main id="main-content" class="flex-1 overflow-y-auto p-4 md:p-8">
            <div id="content-container">
            </div>
        </main>
    </div>

    <script>
        const { jsPDF } = window.jspdf;

        const protocolData = {
            sections: [
                 {
                    id: 'introduction',
                    title: 'Introduction',
                    icon: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
                    content: `
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                           <h2 class="text-2xl font-bold mb-4 text-violet-700">Bienvenue dans le Générateur de Protocoles Sensoriels</h2>
                            <p class="mb-4">Cet outil est conçu pour vous aider à rédiger des protocoles de tests sensoriels complets et standardisés. Remplissez les champs dans chaque section pour construire votre protocole pas à pas. Vous pouvez fermer les sections en cliquant sur leur titre.</p>
                            <div class="mt-6 p-4 bg-violet-50 rounded-lg border border-violet-200">
                                <h3 class="font-semibold text-violet-800">Assistant IA ✨</h3>
                                <p class="text-sm text-violet-700 mt-2">Pour certaines sections complexes, un assistant IA est disponible. Remplissez d'abord les champs de contexte (comme le titre ou la justification), puis cliquez sur le bouton "✨ Suggérer avec l'IA" pour obtenir des propositions intelligentes.</p>
                            </div>
                             <div class="mt-4 p-4 bg-green-50 rounded-lg border border-green-200">
                                <h3 class="font-semibold text-green-800">Exportation PDF</h3>
                                <p class="text-sm text-green-700 mt-2">Une fois que vous avez rempli toutes les sections, cliquez sur le bouton "Exporter en PDF" dans le menu de gauche pour générer un document professionnel de votre protocole.</p>
                            </div>
                        </div>
                    `
                },
                {
                    id: 'identification',
                    title: '1. Identification & Contexte',
                    icon: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002-2h2a2 2 0 002 2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>`,
                    items: [
                        { inputId: 'titre', title: '1. Titre du Protocole', explanation: 'Le titre doit être concis et informatif.', placeholder: 'Ex: Évaluation Hédonique Comparative de Trois Formulations...', type: 'text' },
                        { inputId: 'identifiant', title: '2. Identifiant Unique', explanation: 'Un code unique assure une traçabilité sans faille.', placeholder: 'Ex: AS-PROT-2024-06-BE-005', type: 'text' },
                        { inputId: 'version', title: '3. Version et Date', explanation: 'Le versionnage permet de tracer les modifications.', placeholder: 'Ex: Version 1.1 – 15/07/2024', type: 'text' },
                        { inputId: 'responsable', title: '4. Responsable de l\'Étude', explanation: 'Clarifie les rôles et responsabilités.', placeholder: 'Ex: Dr. Léa Martin', type: 'text' },
                        { inputId: 'contexte', title: '5. Contexte et Justification', explanation: 'Expliquer pourquoi le test est entrepris. Fournit le contexte à l\'IA.', placeholder: 'Ex: Assurer que la réduction de 15% de sucre n\'impacte pas négativement l\'appréciation du produit...', type: 'textarea' },
                        { 
                            inputId: 'objectifs', 
                            title: '6. Objectifs Spécifiques', 
                            explanation: 'Décrire de manière précise ce que le test doit déterminer.', 
                            placeholder: 'Cliquez sur le bouton pour que l\'IA suggère des objectifs basés sur le contexte fourni ci-dessus.', 
                            type: 'textarea',
                            aiPrompt: () => {
                                const contexte = document.getElementById('contexte')?.value || "non spécifié";
                                return `Tu es un expert en analyse sensorielle. En te basant sur le contexte suivant, rédige 3 objectifs spécifiques et mesurables (critères SMART) pour un test sensoriel.\n\nContexte : "${contexte}"`;
                            }
                        }
                    ]
                },
                 {
                    id: 'methodologie',
                    title: '2. Méthodologie',
                    icon: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>`,
                    items: [
                        { inputId: 'testType', title: '7. Type de Test Sensoriel', explanation: 'Le choix du type de test est stratégique. Voir l\'onglet interactif pour plus de détails.', placeholder: 'Ex: Test Affectif (Hédonique)', type: 'text' },
                        { inputId: 'produits', title: '8. Description du/des Produit(s)', explanation: 'Description exhaustive pour une traçabilité parfaite.', placeholder: 'Ex: Produit A: Biscuit \'Croq\'Choc\', Lot N° BC20240512A...', type: 'textarea' },
                        { inputId: 'preparation', title: '9. Préparation et Présentation des Échantillons', explanation: 'Détails précis pour assurer l\'homogénéité et neutraliser les biais.', placeholder: 'Ex: 100mL de soupe servis à 65°C dans des bols en céramique blanche codés...', type: 'textarea' }
                    ]
                },
                {
                    id: 'panel',
                    title: '3. Panel de Dégustateurs',
                    icon: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>`,
                    items: [
                        { inputId: 'panelType', title: '10.1 Type de Panel', explanation: 'Dépend des objectifs du test.', placeholder: 'Ex: 150 consommateurs réguliers de sodas', type: 'text' },
                        { 
                            inputId: 'recrutement', 
                            title: '10.2 Critères de Recrutement', 
                            explanation: 'Critères de sélection du panel. L\'IA peut aider à les définir.', 
                            placeholder: 'Cliquez sur le bouton pour que l\'IA suggère des critères basés sur le type de test et les objectifs.', 
                            type: 'textarea',
                            aiPrompt: () => {
                                const objectifs = document.getElementById('objectifs')?.value || "non spécifié";
                                const testType = document.getElementById('testType')?.value || "non spécifié";
                                return `Tu es un expert en analyse sensorielle. Pour un test de type "${testType}" avec les objectifs suivants, propose une liste détaillée de critères de recrutement pour le panel (critères d'inclusion et d'exclusion, données démographiques, etc.).\n\nObjectifs : "${objectifs}"`;
                            }
                        },
                        { inputId: 'panelSize', title: '10.3 Nombre de Sujets', explanation: 'Doit être justifié statistiquement.', placeholder: 'Ex: 100 consommateurs pour une puissance de 80%', type: 'text' },
                        { inputId: 'formation', title: '10.4 Formation (si applicable)', explanation: 'Essentiel pour les panels entraînés.', placeholder: 'Ex: Formation de 60h sur la texture...', type: 'textarea' },
                        { inputId: 'consignes', title: '10.5 Consignes Avant le Test', explanation: 'Minimiser les interférences sensorielles.', placeholder: 'Ex: Ne pas fumer 2h avant, ne pas utiliser de parfum...', type: 'textarea' }
                    ]
                },
                {
                    id: 'environnement',
                    title: '4. Environnement & Déroulement',
                    icon: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>`,
                    items: [
                        { inputId: 'conditions', title: '11. Conditions de Test', explanation: 'Décrire le local et le matériel.', placeholder: 'Ex: Cabines de dégustation individuelles, éclairage et température contrôlés...', type: 'textarea' },
                        { inputId: 'deroulement', title: '12. Déroulement de la Séance', explanation: 'Instructions et fiche d\'évaluation.', placeholder: 'Ex: Instructions lues au début, réponses collectées sur tablette...', type: 'textarea' }
                    ]
                },
                {
                    id: 'analyse',
                    title: '5. Évaluation & Analyse',
                    icon: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>`,
                    items: [
                        { inputId: 'echelles', title: '13. Descripteurs et Échelles', explanation: 'L\'interface entre perception humaine et quantification.', placeholder: 'Ex: Échelle hédonique à 9 points pour la préférence globale.', type: 'textarea' },
                        { inputId: 'collecte', title: '14. Collecte et Enregistrement', explanation: 'Assurer l\'intégrité des données.', placeholder: 'Ex: Collecte sur tablette via FIZZ, export auto en .csv...', type: 'text' },
                        { inputId: 'statistiques', title: '15. Analyse Statistique', explanation: 'Méthodes adaptées aux données et objectifs.', placeholder: 'Ex: ANOVA sur les notes hédoniques, p < 0.05.', type: 'textarea' },
                        { inputId: 'interpretation', title: '16. Critères d\'Interprétation', explanation: 'Définir la pertinence des résultats.', placeholder: 'Ex: Une différence > 1 point sera considérée comme pertinente.', type: 'text' }
                    ]
                },
                {
                    id: 'rapport',
                    title: '6. Rapport & Annexes',
                    icon: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>`,
                    items: [
                        { inputId: 'contenuRapport', title: '17. Contenu du Rapport', explanation: 'Définir la structure type du rapport final.', placeholder: 'Ex: Rapport structuré avec un résumé exécutif...', type: 'textarea' },
                        { inputId: 'ethique', title: '18. Confidentialité & Éthique', explanation: 'Anonymat et consentement éclairé des panélistes.', placeholder: 'Ex: Signature d\'un formulaire de consentement éclairé...', type: 'text' },
                        { inputId: 'references', title: '19. Références', explanation: 'Légitimité et crédibilité de la démarche.', placeholder: 'Ex: NF EN ISO 8589: Conception des locaux d\'essais.', type: 'textarea' },
                        { inputId: 'annexes', title: '20. Annexes', explanation: 'Rendre le protocole pleinement opérationnel.', placeholder: 'Ex: Annexe 1: Modèle du formulaire de consentement.', type: 'textarea' }
                    ]
                }
            ]
        };

        const toggleLoading = (isLoading) => {
            const overlay = document.getElementById('loading-overlay');
            if (isLoading) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        };

        async function generateWithAI(targetInputId, promptFunction, button) {
            const targetInput = document.getElementById(targetInputId);
            const prompt = promptFunction();
            
            if (!prompt) {
                alert("Veuillez remplir les champs de contexte nécessaires avant d'utiliser l'IA.");
                return;
            }

            button.disabled = true;
            button.innerHTML = 'Génération en cours...';
            toggleLoading(true);

            try {
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.statusText}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    targetInput.value = text.trim();
                    targetInput.style.height = 'auto';
                    targetInput.style.height = (targetInput.scrollHeight) + 'px';
                } else {
                    targetInput.value = "Désolé, une erreur est survenue lors de la génération. Veuillez réessayer.";
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                targetInput.value = "Erreur de connexion à l'API. Vérifiez la console pour plus de détails.";
            } finally {
                button.disabled = false;
                button.innerHTML = '✨ Suggérer avec l\'IA';
                toggleLoading(false);
            }
        }
        
        function renderAccordions(items) {
            return items.map(item => {
                const isTextarea = item.type === 'textarea';
                const inputElement = isTextarea
                    ? `<textarea id="${item.inputId}" class="form-textarea" placeholder="${item.placeholder}"></textarea>`
                    : `<input type="text" id="${item.inputId}" class="form-input" placeholder="${item.placeholder}">`;
                
                const aiButton = item.aiPrompt 
                    ? `<div class="mt-2 flex justify-end">
                         <button class="ai-button" data-target="${item.inputId}">✨ Suggérer avec l'IA</button>
                       </div>` 
                    : '';

                return `
                <div class="mb-2">
                    <div class="accordion-header bg-white rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold">${item.title}</h3>
                        <svg class="accordion-arrow w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="accordion-content">
                        <div class="space-y-2">
                            <div>
                                <h4 class="font-semibold text-violet-600">Explication</h4>
                                <p class="mt-1 text-sm text-gray-600">${item.explanation}</p>
                            </div>
                            <div class="pt-2">
                                <label for="${item.inputId}" class="font-semibold text-gray-700">Votre saisie :</label>
                                ${inputElement}
                                ${aiButton}
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
        
        function renderSection(section) {
            const container = document.getElementById('content-container');
            if (section.id === 'introduction') {
                container.innerHTML = section.content;
            } else {
                container.innerHTML = `
                    <h2 class="text-3xl font-bold mb-6">${section.title}</h2>
                    <div id="accordion-container">
                        ${renderAccordions(section.items)}
                    </div>`;
            }

            document.querySelectorAll('.accordion-header').forEach(header => {
                header.addEventListener('click', () => {
                    const content = header.nextElementSibling;
                    const isOpen = content.classList.contains('open');
                    document.querySelectorAll('.accordion-content.open').forEach(openContent => {
                        openContent.classList.remove('open');
                        openContent.previousElementSibling.classList.remove('open');
                    });
                    if (!isOpen) {
                        content.classList.add('open');
                        header.classList.add('open');
                    }
                });
            });

            section.items?.forEach(item => {
                if (item.aiPrompt) {
                    const button = document.querySelector(`button[data-target="${item.inputId}"]`);
                    if(button) {
                        button.addEventListener('click', (e) => {
                            generateWithAI(item.inputId, item.aiPrompt, e.currentTarget);
                        });
                    }
                }
            });
        }
        
        async function exportToPdf() {
            toggleLoading(true);
            const doc = new jsPDF({
                orientation: 'p',
                unit: 'mm',
                format: 'a4'
            });
            const margin = 15;
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const usableWidth = pageWidth - 2 * margin;
            let y = margin;
            
            const protocolTitle = document.getElementById('titre')?.value || "Protocole Sensoriel";
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(18);
            doc.text(protocolTitle, pageWidth / 2, y, { align: 'center' });
            y += 15;

            for (const section of protocolData.sections) {
                if (!section.items) continue;

                if (y > pageHeight - margin - 20) { // Check for page break
                    doc.addPage();
                    y = margin;
                }
                
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(14);
                doc.setTextColor(93, 33, 187); // Violet color
                doc.text(section.title, margin, y);
                y += 8;

                for (const item of section.items) {
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(11);
                    doc.setTextColor(0, 0, 0);
                    
                    const itemTitleLines = doc.splitTextToSize(item.title, usableWidth);
                    doc.text(itemTitleLines, margin, y);
                    y += itemTitleLines.length * 5;

                    const value = document.getElementById(item.inputId)?.value || "Non renseigné";
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    doc.setTextColor(75, 85, 99);
                    
                    const valueLines = doc.splitTextToSize(value, usableWidth);
                    if (y + valueLines.length * 4.5 > pageHeight - margin) {
                        doc.addPage();
                        y = margin;
                    }
                    doc.text(valueLines, margin + 5, y);
                    y += valueLines.length * 4.5 + 5;
                }
                y += 5; // Extra space between sections
            }
            toggleLoading(false);
            doc.save(`${protocolTitle.replace(/ /g, '_')}.pdf`);
        }

        function buildNav() {
            const navContainer = document.getElementById('main-nav');
            protocolData.sections.forEach(section => {
                const link = document.createElement('a');
                link.className = 'nav-link';
                link.dataset.section = section.id;
                link.innerHTML = `${section.icon} ${section.title}`;
                navContainer.appendChild(link);
            });
        }

        function handleNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    const sectionId = link.dataset.section;
                    navLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    const sectionData = protocolData.sections.find(s => s.id === sectionId);
                    
                    const container = document.getElementById('content-container');
                    container.style.opacity = 0;
                    setTimeout(() => {
                        renderSection(sectionData);
                        container.style.opacity = 1;
                        container.scrollTop = 0;
                        document.querySelector('.accordion-header')?.click();
                    }, 200);
                });
            });
        }

        function init() {
            buildNav();
            handleNavigation();
            document.querySelector('.nav-link[data-section="introduction"]').click();
            document.getElementById('export-pdf-button').addEventListener('click', exportToPdf);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
